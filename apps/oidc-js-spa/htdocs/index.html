<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <title>Mini SPA Demo</title>

    <style>
        body {
            background-color: #eaeaea;
            font-family: sans-serif;
            font-size: 10px;
        }

        button {
            font-family: sans-serif;
            font-size: 25px;
            width: 200px;

            background-color: #0085cf;
            background-image: linear-gradient(to bottom, #00a8e1 0%, #0085cf 100%);
            background-repeat: repeat-x;

            border: 2px solid #ccc;
            color: #fff;

            text-transform: uppercase;

            -webkit-box-shadow: 2px 2px 10px 0px rgba(0, 0, 0, 0.5);
            -moz-box-shadow: 2px 2px 10px 0px rgba(0, 0, 0, 0.5);
            box-shadow: 2px 2px 10px 0px rgba(0, 0, 0, 0.5);
        }

        button:hover {
            background-color: #006ba6;
            background-image: none;
            -webkit-box-shadow: none;
            -moz-box-shadow: none;
            box-shadow: none;
        }

        hr {
            border: none;
            background-color: #eee;
            height: 10px;
        }

        .menu {
            padding: 10px;
            margin-bottom: 10px;
        }

        .content {
            font-size: 20px;
            background-color: #eee;
            border: 1px solid #ccc;
            padding: 10px;

            -webkit-box-shadow: 2px 2px 10px 0 rgba(0, 0, 0, 0.5);
            -moz-box-shadow: 2px 2px 10px 0 rgba(0, 0, 0, 0.5);
            box-shadow: 2px 2px 10px 0 rgba(0, 0, 0, 0.5);
        }

        .message-content {
            font-size: 20px;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
        }

        .token-content {
            font-size: 20px;
            padding: 5px;
            white-space: pre;
            text-transform: none;
        }

        .wrapper {
            position: absolute;
            left: 10px;
            top: 40px;
            bottom: 10px;
            right: 10px;
        }

        .error {
            color: #a21e22;
        }

        table {
            width: 100%;
        }

        tr.even {
            background-color: #eee;
        }

        td {
            padding: 5px;
        }

        td.label {
            font-weight: bold;
            width: 250px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>

<div>
    <h1>ClientId: <span id="clientInfo"></span></h1>
</div>

<div id="welcome" class="wrapper hidden">
    <div class="menu">
        <button name="loginBtn" onclick="keycloak.login()">Login</button>
    </div>

    <div class="message-content">
        <div class="message">Please login</div>
    </div>
</div>

<div id="content" class="wrapper hidden">
    <div class="menu">
        <button name="profileBtn" onclick="showProfile()">Profile</button>
        <button name="tokenBtn" onclick="showToken()">AccessToken</button>
        <button name="idTokenBtn" onclick="showIdToken()">IDToken</button>
        <button name="userinfoBtn" onclick="showUserInfo()">Userinfo</button>
        <button name="meBtn" onclick="showMeInfo()">Me Info</button>
        <button name="settingsBtn" onclick="showSettings()">Settings</button>
        <button name="changePasswordBtn" onclick="changePassword()">Password</button>
        <button name="reauthBtn" onclick="enforceCurrentAuth()">ReAuth</button>
        <button name="accountBtn" onclick="keycloak.accountManagement()">Account</button>
        <button name="logoutBtn" onclick="keycloak.logout()">Logout</button>
    </div>

    <div id="data" class="content"></div>
</div>


<script defer>

    let searchParams = new URLSearchParams(window.location.search);
    let keycloakBaseUrl = searchParams.get("base_url") || (window.location.protocol === "http:" ? "http://localhost:8080" : "https://id.acme.test:8443");
    let keycloakUrl = keycloakBaseUrl + (searchParams.get("path") || "/auth");

    let realm = searchParams.get("realm") || 'custom';
    let clientId = searchParams.get("client_id") || 'app-minispa';

    // ?scope=openid+email+custom.profile+custom.ageinfo
    let scope = searchParams.get("scope") || 'openid email acme.profile';
    // &show=profileBtn,accountBtn,meBtn,tokenBtn,idTokenBtn,userinfoBtn,reauthBtn,logoutBtn
    // &show=acme-apps&show=profileBtn,logoutBtn

    const allButtons = ["profileBtn", "accountBtn", "settingsBtn", "meBtn", "tokenBtn", "idTokenBtn", "userinfoBtn", "reauthBtn", "logoutBtn"];
    const uiElementsToShowDefault = [...allButtons].filter((value, index, arr) => {
        return value != 'meBtn';
    });

    let uiElementsToShow = searchParams.get("show")?.split(",") || uiElementsToShowDefault;
    for (let btnName of allButtons) {
        if (!uiElementsToShow.includes(btnName)) {
            let btn = document.querySelector(`button[name=${btnName}]`);
            if (btn) {
                btn.parentElement.removeChild(btn);
            }
        }
    }

    document.getElementById("clientInfo").textContent = clientId;

    // dynamically add keycloak.js script
    let script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = keycloakUrl + "/js/keycloak.js";
    document.getElementsByTagName('head')[0].appendChild(script);

    window.onload = () => {

        window.keycloak = new Keycloak({
            url: keycloakUrl,
            realm: realm,
            clientId: clientId
        });

        let initConfig = {
            onLoad: 'login-required', // redirects to login if not login
            // onLoad: 'check-sso', // shows login button of not logged in
            checkLoginIframe: true,
            checkLoginIframeInterval: 1,
            pkceMethod: 'S256',
            scope: scope
        };

        let onLoginSuccess = () => {
            if (keycloak.authenticated) {
                showProfile();
            } else {
                showWelcome();
            }
        };

        keycloak.init(initConfig).success(onLoginSuccess);

        keycloak.onAuthLogout = showWelcome;
    };

    function showWelcome() {
        document.getElementById("welcome").classList.remove("hidden");
        document.getElementById("content").classList.add("hidden");
    }

    function getTimeSinceLastAuth() {
        let timeSinceAuthInSeconds = Math.floor((Date.now() - (keycloak.tokenParsed.auth_time * 1000)) / 1000);
        return timeSinceAuthInSeconds;
    }

    function enforceCurrentAuth() {

        let timeSinceAuthSeconds = getTimeSinceLastAuth();
        console.log("time since auth: " + timeSinceAuthSeconds);

        if (timeSinceAuthSeconds < 10) {
            console.log("auth is still file")
            return;
        } else {
            console.log("trigger reauth")
        }

        keycloak.login({
            loginHint: keycloak.tokenParsed.preferred_username,
            maxAge: 12
        });
    }

    function changePassword() {
        keycloak.login({
            action: "UPDATE_PASSWORD"
        });
    }

    function showProfile() {

        let profileHtml = `
            <table>
                <tr>
                    <td class="label">First name</td>
                    <td><span id="firstName">${keycloak.tokenParsed['given_name']}</span></td>
                </tr>
                <tr>
                    <td class="label">Last name</td>
                    <td><span id="lastName">${keycloak.tokenParsed['family_name']}</span></td>
                </tr>
                <tr>
                    <td class="label">Email</td>
                    <td><span id="email">${keycloak.tokenParsed['email']}</span></td>
                </tr>
            </table>
        `;
        show(profileHtml, "message-content");
    }

    async function showSettings() {

        await keycloak.updateToken(5);

        let settingsData;
        try {
            let response = await fetch(`${keycloakUrl}/realms/${realm}/custom-resources/settings/me`, {
                timeout: 2000,
                headers: {
                    "Authorization": "Bearer " + keycloak.token,
                    "Accept": "application/json"
                }
            });

            if (response.ok) {
                settingsData = await response.json();
            } else {
                settingsData = {error: "status " + response.status};
            }
        } catch (error) {
            console.log(error);
            settingsData = {error: error.message};
        }

        let settingsHtml = `
        <form id="frmSettings" name="frmSettings" action="" onsubmit="return false" onkeydown="return event.key != 'Enter';">
            <table>
                <tr>
                    <td class="label"><label for="setting1">Setting 1</label></td>
                    <td><input type="text" id="setting1" name="setting1" value="${settingsData.setting1}" pattern="[\d\w]{0,20}"></td>
                </tr>
                <tr>
                    <td class="label"><label for="setting2">Setting 2</label></td>
                    <td><input type="checkbox" id="setting2" name="setting2" ${settingsData.setting2 ? "checked" : ""}></td>
                </tr>
            </table>
            <button id="btnSaveSettings" onClick="saveSettings(); return false">Save</button>
            <span id="settingsStatus"></span>
            </form>
        `;
        show(settingsHtml, "message-content");
    }

    async function saveSettings() {

        await keycloak.updateToken(5);

        let settings = {
            "setting1": document.getElementById("setting1").value,
            "setting2": document.getElementById("setting2").checked
        };

        try {

            let settingsStatus = document.getElementById("settingsStatus");
            settingsStatus.innerText = "Saving settings ...";

            let btnSave = document.getElementById("btnSaveSettings");
            btnSave.disabled = true;

            let response = await fetch(`${keycloakUrl}/realms/${realm}/custom-resources/settings/me`, {
                timeout: 2000,
                method: "PUT",
                headers: {
                    "Authorization": "Bearer " + keycloak.token,
                    "Accept": "application/json",
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(settings)
            });

            if (response.ok) {
                newSettingsData = await response.json();
                settingsStatus.innerText = "Settings saved";
            } else {
                newSettingsData = {error: "status " + response.status};
                settingsStatus.innerText = "Could not save settings";
            }
            setTimeout(() => {
                settingsStatus.innerText = "";
                btnSave.disabled = false;
            }, 1000)
        } catch (error) {
            console.log(error);
            newSettingsData = {error: error.message};
        }
    }

    function showToken() {

        let data = JSON.stringify(keycloak.tokenParsed, null, '    ');
        show(data, "token-content");
    }

    function showIdToken() {

        let data = JSON.stringify(keycloak.idTokenParsed, null, '    ');
        show(data, "token-content");
    }

    async function showUserInfo() {

        await keycloak.updateToken(5);

        let userInfoData = await keycloak.loadUserInfo();

        let data = JSON.stringify(userInfoData, null, '    ');
        show(data, "token-content");
    }

    async function showMeInfo() {

        await keycloak.updateToken(5);

        let meData;
        try {
            let response = await fetch("https://apps.acme.test:4543/api/users/me", {
                timeout: 2000,
                headers: {
                    "Authorization": "Bearer " + keycloak.token,
                    "Accept": "application/json"
                }
            });

            if (response.ok) {
                meData = await response.json();
            } else {
                meData = {error: "status " + response.status};
            }
        } catch (error) {
            console.log(error);
            meData = {error: error.message};
        }

        let data = JSON.stringify(meData, null, '    ');
        show(data, "token-content");
    }

    function show(data, cssClass) {

        let contentElement = document.getElementById('content');
        contentElement.classList.remove("hidden")

        let dataElement = document.getElementById('data');
        dataElement.innerHTML = data;
        dataElement.classList.remove(["message-content", "token-content"]);
        dataElement.classList.add(cssClass);
    }
</script>
</body>

</html>